name: Record Birthday GIF
on:
  repository_dispatch:
    types: [birthday_trigger]

jobs:
  record_gif:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer, Chrome, and FFmpeg
        run: |
          npm install puppeteer puppeteer-screen-recorder
          npx puppeteer browsers install chrome
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run Recording Script
        env:
          EMPLOYEE_NAME: ${{ github.event.client_payload.name }}
        run: |
          cat << 'EOF' > record.js
          const puppeteer = require('puppeteer');
          const { PuppeteerScreenRecorder } = require('puppeteer-screen-recorder');

          (async () => {
            const browser = await puppeteer.launch({
              headless: "new",
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            
            // Matches your email display size
            await page.setViewport({ width: 600, height: 400 });

            const name = process.env.EMPLOYEE_NAME || 'Team Member';
            // Points to your specific URL
            const url = `https://oh3alarab-jpg.github.io/happy-birthday/?name=${encodeURIComponent(name)}`;
            
            const recorder = new PuppeteerScreenRecorder(page);
            await page.goto(url, { waitUntil: 'networkidle0' });

            // Records 10 seconds of your animation
            await recorder.start('video.mp4');
            await new Promise(resolve => setTimeout(resolve, 5000)); 
            await recorder.stop();

            await browser.close();
          })();
          EOF
          node record.js

      - name: Convert MP4 to Optimized GIF
        run: |
          ffmpeg -i video.mp4 -vf "fps=10,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen[p];[s1][p]paletteuse" birthday.gif

      - name: Clean up and Upload GIF
        run: |
          git config --global user.name "BirthdayBot"
          git config --global user.email "bot@github.com"
          
          mkdir -p generated_gifs
          
          # JANITOR STEP: Remove any GIFs older than 3 days to prevent repository bloat
          find generated_gifs/ -name "*.gif" -type f -mtime +3 -delete
          
          # Move the new GIF to the folder
          mv birthday.gif "generated_gifs/${{ github.event.client_payload.name }}_birthday.gif"
          
          git add .
          git commit -m "Generated GIF and cleaned old files for ${{ github.event.client_payload.name }}"
          git push
